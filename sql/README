
For more information, see:

http://dev.lsstcorp.org/trac/wiki/dbDC3aSetup


Policy files needed
===================

1) "mysqlsu.txt". Contents:
    - mysql superuser name
    - mysql superuser password

2) "globalDBPolicy.txt". Contents:
    - path to the setup scripts (these in DMS/cat/??/sql/)
    - mysql superuser name
    - mysql superuser password

3) "perRunDBPolicy.txt". Contents:
 -  path to the setup scripts (these in DMS/cat/??/sql/)
  - minimum percentage of disk space required to start a run in % (eg 10)
  - lifetime of a user-type runs measured in weeks (eg 2)
  - dc version (eg DC3a)
  - list of mysql user accounts authorized to start production runs

4) "cleanupExpiredRunsPolicyFile.txt". Contents:
  - dcVersion # eg "DC3a"
  - dbHostName # name of the mysql server host, eg lsst10
  - mysql superuser name
  - mysql superuser password
  - global database name
  - daysFirstNotice (# days when first notice is sent before run can 
                     be deleted, a reasonable value is 7)
  - daysFinalNotice (# days when final notice is sent before run can 
                     be deleted, a reasonable value is 1)



MySQL Account management
========================

Assuption: to start a run, user needs to have mysql account,
appropriate authorizations, and her/his email should be 
registered in mysql database.

To authorize user, use: addMySqlUser.py command. It takes 
the following arguments:

addMySqlUser.py -f {policyFile} -s {mysqlServerHost} -u {userName} 
                -p {userPassword} -e {userEmail} -c {clientHost} 
                -g {globalDbName} -v {dcVersion}
Where:
  - policyFile:      the policy file containing mysql superuser name and password.
  - mysqlServerHost: host name where the mysql server runs
  - userName:        mysql username of the added user
  - userPassword:    mysql password of the added user
  - userEmail:       email address of the added user
  - clientHost:      host name where user will jobs, wildcards allowed
  - globalDbName:    name of the mysql "global database"
  - dcVersion:       DC version, eg DC3a


Notice that GlobalDB must be setup prior to adding users.


One-time setup
==============

To do one-time setup, run the function setupGlobalDB
from administerRuns.py. Example

#!/usr/bin/env python
from administerRuns import AdminRuns
x = AdminRuns("lsst10",    # mysql server host
              "GlobalDB")  # name of the global database

x.setupGlobalDB("globalDBPolicy.txt")



checking status before starting a run
=====================================

Run this prior to starting a run to check
if the database is properly set up.

Execute the function checkStatus() from administerRuns.py. 

Example:

#!/usr/bin/env python
from administerRuns import AdminRuns
x = AdminRuns("lsst10",    # mysql server host
              "GlobalDB")  # name of the global database

x.checkStatus("perRunDBPolicy.txt", 
              "jacek",  # non-superuser
              "p",      # password
              "ds33")   # machine where mysql client is executed


Per run setup
=============

Run this at the beginning of starting the run.

Execute the function prepareForNewRun from adminsterRuns.py

Example:

#!/usr/bin/env python
from administerRuns import AdminRuns
x = AdminRuns("lsst10",    # mysql server host
              "GlobalDB")  # name of the global database

x.prepareForNewRun("perRunDBPolicy.txt", 
                   "myFirstRun",  # run name
                   "u",           # run type ('u' or 'p')
                   "becla",       # user name
                   "pwd")         # user password;



Asynchronous
============

The following should be executed once every 24h, eg at midnight:

 /DMS/cat/???/scripts/cleanExpiredRuns.py "cleanupExpiredRunsPolicyFile.txt"
